<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Empire War</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>

<div class="main">
    <div class="container">
        <div class="left initial run" data-count="1" id="itemX">
            <span class="l item"></span>
        </div>
        <div class="right initial run" data-count="1" id="itemY">
            <span class="r item"></span>
        </div>
        <div class="initial"></div>
        <div class="initial"></div>
    </div>
</div>

<script src="jquery.js"></script>
<script>
    $(document).ready(function () {
        var canMove = false;
        var clonedItems = 0;
        var itemId;
        var selectedArea;
        var selectedItemParent;
        var divide;

        var initialTimer = setTimeout(function initial() {
            $('.run').each(function (i, e) {
                let count = +$(this).attr('data-count');
                count++;
                $(this).attr('data-count', count);
            });
            initialTimer = setTimeout(initial, 800);
        }, 800);

        $('.run').children('span').mousedown(function (e) {
            e.preventDefault();
            canMove = true;
            selectedItemParent = $(this).parent();
            clonedItems += 1;
            itemId = 'item'+clonedItems;
            let classNames = e.target.className;
            $('<span/>', {
                class: classNames+' absolute',
                id: itemId
            }).appendTo('body');
            $('#' + itemId).css({top: e.pageY, left: e.pageX});

        });
        $(document).mouseup(function (e) {
            e.preventDefault();
            // console.log(e);
            // console.log(selectedArea);
            // console.log(selectedItemParent.attr('data-count'));
            divide = +selectedItemParent.attr('data-count')%2 === 0 ? +selectedItemParent.attr('data-count')/2 : (+selectedItemParent.attr('data-count')+1)/2;
            if (selectedArea){
                // console.log(selectedArea.hasClass('run'),selectedArea);
                if (!selectedArea.hasClass('run')){
                    selectedItemParent.attr('data-count', divide);
                    selectedArea.removeClass('active-border');
                    selectedArea.append($('#' + itemId));
                    selectedArea.addClass('run');
                    if (!selectedArea.attr('data-count')){
                        selectedArea.attr('data-count', divide);
                    } else {
                        let increment = +selectedArea.attr('data-count')+divide;
                        selectedArea.attr('data-count', increment);
                    }
                    $('#' + itemId).removeClass('absolute')
                } else {
                    console.log(selectedArea.children('span'), selectedArea.children('span').attr('class'));
                    $('#' + itemId).remove();
                }
            } else {
                $('#' + itemId).remove();
            }
            canMove = false;
            selectedArea = undefined;
            selectedItemParent = undefined;
        });
        $(document).mousemove(function (e) {
            e.preventDefault();
            if(!canMove) return;
            $('#' + itemId).css({top: e.pageY, left: e.pageX})
        });
        $('.initial').on({
            mouseenter: function (e) {
                e.preventDefault();
                if(!canMove) return;
                if ($(this).attr('id') === undefined){
                    $(this).addClass('active-border');
                    selectedArea = $(this);
                }
            }
        })
    })
</script>
</body>
</html>
